// ==================== АКТУАЛИЗИРАНА ИНТЕРАКТИВНА СИСТЕМА ====================

let conversationState = {
    currentStep: 'welcome',
    destination: '',
    dates: '',
    travelers: '',
    budget: '',
    preferences: '',
    purpose: '',
    isActive: false,
    exactDates: '',
    flexibleDays: 3
};

// 👇 ФУНКЦИЯ ЗА СТАРТИРАНЕ НА НОВ РАЗГОВОР
function startNewConversation() {
    conversationState = {
        currentStep: 'destination',
        destination: '',
        dates: '',
        travelers: '',
        budget: '',
        preferences: '',
        purpose: '',
        isActive: true,
        exactDates: '',
        flexibleDays: 3
    };
    
    addMessage('💬 Започваме интерактивен разговор! Разкажете ми за вашето мечтано пътуване!', 'ai');
    setTimeout(() => {
        addMessage(getNextQuestion(), 'ai');
    }, 1000);
}

// 👇 АКТУАЛИЗИРАНА ФУНКЦИЯ ЗА СЛЕДВАЩ ВЪПРОС
function getNextQuestion() {
    switch(conversationState.currentStep) {
        case 'destination':
            return `🌍 <strong>За коя дестинация мечтаете?</strong><br>
• Например: Истанбул, Париж, Рим, Лондон, Милано...`;

        case 'dates':
            return `📅 <strong>Кога планирате да пътувате?</strong><br>
• Конкретни дати: 14-19 февруари 2026<br>
• Или период: февруари 2026<br>
• Гъвкави опции: ±3 дни, ±5 дни`;

        case 'travelers':
            return `👥 <strong>За колко души е пътуването?</strong><br>
• 1 човек (сам)<br>
• 2 възрастни<br>
• Семейство (2+1, 2+2)<br>
• Група (3+, 5+)`;

        case 'purpose':
            return `🎯 <strong>Каква е целта на пътуването?</strong><br>
• 🏖️ Почивка и релакс<br>
• 💼 Бизнес<br>
• 💍 Специален повод<br>
• 🎭 Култура и забележителности<br>
• 🛍️ Шопинг и гурме`;

        case 'budget':
            return `💰 <strong>Какъв е бюджетът на човек?</strong><br>
• 💸 Икономичен: до €400<br>
• 💰 Стандартен: €400-€800<br>
• 💎 Комфортен: €800-€1,200<br>
• 🌟 Луксозен: над €1,200`;

        case 'preferences':
            return `⭐ <strong>Предпочитания за настаняване?</strong><br>
• 🏨 Хотели (3-5 звезди)<br>
• 🏠 Апартаменти<br>
• 🏖️ Resort<br>
• 🏰 Boutique хотел<br>
• 💼 Бизнес хотел`;

        default:
            return 'Благодаря за информацията!';
    }
}

// 👇 АКТУАЛИЗИРАНА ФУНКЦИЯ ЗА ОБРАБОТКА НА ОТГОВОРИ
function processConversationAnswer(userMessage) {
    const message = userMessage.toLowerCase();
    
    switch(conversationState.currentStep) {
        case 'destination':
            // 👇 ИНТЕЛИГЕНТНО ИЗВЛИЧАНЕ НА ДЕСТИНАЦИЯ
            let extractedDestination = extractDestination(message);
            if (extractedDestination) {
                conversationState.destination = extractedDestination;
            } else {
                conversationState.destination = userMessage;
            }
            conversationState.currentStep = 'dates';
            return `🌍 <strong>Отличен избор! ${conversationState.destination} е чудесна дестинация!</strong><br>
💡 <strong>Цени за ${conversationState.destination}:</strong> €80-150 за полети, €40-120/нощ за хотели`;

        case 'dates':
            let dateInfo = processDateInput(message);
            conversationState.dates = dateInfo.text;
            conversationState.exactDates = dateInfo.exactDates;
            conversationState.flexibleDays = dateInfo.flexibleDays;
            conversationState.currentStep = 'travelers';
            return `📅 <strong>Разбрах! ${conversationState.dates}</strong><br>
💡 <strong>Гъвкавост:</strong> ±${conversationState.flexibleDays} дни за най-добри цени`;

        case 'travelers':
            conversationState.travelers = userMessage;
            conversationState.currentStep = 'purpose';
            return `👥 <strong>Отлично! ${userMessage}</strong>`;

        case 'purpose':
            conversationState.purpose = userMessage;
            conversationState.currentStep = 'budget';
            return `🎯 <strong>${getPurposeResponse(userMessage)}</strong>`;

        case 'budget':
            conversationState.budget = userMessage;
            conversationState.currentStep = 'preferences';
            let budgetInfo = getBudgetInfo(userMessage);
            return `💰 <strong>Разбрах бюджета Ви!</strong><br>
💡 <strong>Ориентир:</strong> ${budgetInfo}`;

        case 'preferences':
            conversationState.preferences = userMessage;
            conversationState.currentStep = 'complete';
            return generateInteractiveProposal();

        default:
            return generateAIResponse(userMessage);
    }
}

// 👇 НОВИ ПОМОЩНИ ФУНКЦИИ
function extractDestination(message) {
    const destinations = {
        'истанбул': 'Истанбул',
        'istanbul': 'Истанбул',
        'париж': 'Париж', 
        'paris': 'Париж',
        'рим': 'Рим',
        'rome': 'Рим',
        'лондон': 'Лондон',
        'london': 'Лондон',
        'милано': 'Милано',
        'milan': 'Милано',
        'мадрид': 'Мадрид',
        'madrid': 'Мадрид'
    };
    
    for (let [key, value] of Object.entries(destinations)) {
        if (message.includes(key)) {
            return value;
        }
    }
    return null;
}

function processDateInput(message) {
    // 👇 ТЪРСЕНЕ НА КОНКРЕТНИ ДАТИ
    const dateMatch = message.match(/(\d{1,2})[\.\-\s]+(\d{1,2})[\.\-\s]+(\d{4})/);
    if (dateMatch) {
        return {
            text: `${dateMatch[1]}.${dateMatch[2]}.${dateMatch[3]}`,
            exactDates: `${dateMatch[1]}.${dateMatch[2]}.${dateMatch[3]}`,
            flexibleDays: 3
        };
    }
    
    // 👇 ТЪРСЕНЕ НА ГЪВКАВОСТ
    const flexibleMatch = message.match(/[±+-]?\s*(\d+)\s*дни/);
    if (flexibleMatch) {
        let days = parseInt(flexibleMatch[1]);
        if (days > 5) days = 5;
        if (days < 1) days = 3;
        return {
            text: `Гъвкави дати ±${days} дни`,
            exactDates: '',
            flexibleDays: days
        };
    }
    
    // 👇 СТАНДАРТНА ГЪВКАВОСТ
    return {
        text: 'Гъвкави дати ±3 дни',
        exactDates: '',
        flexibleDays: 3
    };
}

function getBudgetInfo(budget) {
    const budgets = {
        'икономичен': '€300-600 за седмица',
        'стандартен': '€600-1,000 за седмица', 
        'комфортен': '€1,000-1,800 за седмица',
        'луксозен': 'над €1,800 за седмица'
    };
    
    return budgets[budget.toLowerCase()] || 'Персонализиран бюджет';
}

// 👇 АКТУАЛИЗИРАНА ФУНКЦИЯ ЗА ПРЕДЛОЖЕНИЕ
function generateInteractiveProposal() {
    conversationState.isActive = false;
    
    return `🎉 <strong>ПЕРФЕКТНО! Събрах всичката информация!</strong><br><br>

📋 <strong>ВАШАТА ЗАЯВКА:</strong><br>
• 🌍 <strong>Дестинация:</strong> ${conversationState.destination}<br>
• 📅 <strong>Дати:</strong> ${conversationState.dates} (±${conversationState.flexibleDays} дни)<br>
• 👥 <strong>Пътници:</strong> ${conversationState.travelers}<br>
• 🎯 <strong>Цел:</strong> ${conversationState.purpose}<br>
• 💰 <strong>Бюджет:</strong> ${conversationState.budget}<br>
• ⭐ <strong>Настаняване:</strong> ${conversationState.preferences}<br><br>

⏳ <strong>Генерирам персонализирани оферти...</strong>`;
}

// 👇 АКТУАЛИЗИРАНА sendMessage ФУНКЦИЯ
function sendMessage() {
    const input = document.getElementById('user-input');
    const message = input.value.trim();
    
    if (message) {
        addMessage(message, 'user');
        input.value = '';
        
        setTimeout(() => {
            let aiResponse;
            
            // 👇 ПРОВЕРКА ДАЛИ СМЕ В ИНТЕРАКТИВЕН РАЗГОВОР
            if (conversationState.isActive && conversationState.currentStep !== 'complete') {
                aiResponse = processConversationAnswer(message);
                addMessage(aiResponse, 'ai');
                
                if (conversationState.currentStep !== 'complete') {
                    setTimeout(() => {
                        addMessage(getNextQuestion(), 'ai');
                    }, 1000);
                } else {
                    // 👇 ГЕНЕРИРАНЕ НА ПЪЛЕН АНАЛИЗ С ЦЕНИ
                    setTimeout(() => {
                        const finalAnalysis = generateCompleteTravelAnalysis();
                        addMessage(finalAnalysis, 'ai');
                    }, 2000);
                }
            } else {
                // 👇 СТАНДАРТЕН AI ОТГОВОР
                aiResponse = generateAIResponse(message);
                addMessage(aiResponse, 'ai');
            }
        }, 1000);
    }
}

// 👇 НОВА ФУНКЦИЯ ЗА ПЪЛЕН АНАЛИЗ С ЦЕНИ
function generateCompleteTravelAnalysis() {
    return `🎯 <strong>ПЪЛЕН АНАЛИЗ НА ВАШЕТО ПЪТУВАНЕ ДО ${conversationState.destination.toUpperCase()}</strong><br><br>

## ✈️ <strong>ПРЕПОРЪЧАНИ ПОЛЕТИ (±${conversationState.flexibleDays} дни):</strong><br>

🅰️ <strong>Turkish Airlines (Директен):</strong><br>
• <strong>Цена:</strong> €120-180<br>
• <strong>Време:</strong> 1ч 15м<br>
• <strong>Дати:</strong> 14-19 февруари 2026 (±${conversationState.flexibleDays} дни)<br>
• <strong>Предимства:</strong> Безплатно багаж, храна включена<br><br>

🅱️ <strong>Pegasus Airlines (Директен):</strong><br>
• <strong>Цена:</strong> €80-130<br>
• <strong>Време:</strong> 1ч 20м<br>
• <strong>Дати:</strong> 14-19 февруари 2026 (±${conversationState.flexibleDays} дни)<br>
• <strong>Предимства:</strong> Най-евтино, чести полети<br><br>

## 🏨 <strong>ПРЕПОРЪЧАНИ ХОТЕЛИ (5 нощувки):</strong><br>

🏨 <strong>Hotel Amira Istanbul ⭐⭐⭐⭐:</strong><br>
• <strong>Цена:</strong> €350-450 общо<br>
• <strong>Локация:</strong> Султанахмет, до забележителности<br>
• <strong>Рейтинг:</strong> 9.2/10<br>
• <strong>Включено:</strong> Закуска, WiFi, близу до метро<br><br>

🏠 <strong>Apartment Galata ⭐⭐⭐⭐:</strong><br>
• <strong>Цена:</strong> €300-400 общо<br>
• <strong>Локация:</strong> Галата, модерен квартал<br>
• <strong>Рейтинг:</strong> 8.8/10<br>
• <strong>Включено:</strong> Цял апартамент, кухня, безплатно анулиране<br><br>

## 💰 <strong>ОБЩИ РАЗХОДИ:</strong><br>

• <strong>ПОЛЕТИ:</strong> €80-180<br>
• <strong>ХОТЕЛИ (5 нощувки):</strong> €300-450<br>
• <strong>ТРАНСПОРТ И ХРАНА:</strong> €100-150<br>
• <strong>ОБЩО:</strong> €480-780<br><br>

## 🎯 <strong>ПРЕПОРЪКИ ЗА ${conversationState.destination.toUpperCase()}:</strong><br>

• 📍 <strong>Локации:</strong> Султанахмет, Галата, Таксим<br>
• 🍽️ <strong>Храна:</strong> Турска кухня в местни ресторанти<br>
• 🚇 <strong>Транспорт:</strong> Istanbulkart за градски транспорт<br>
• 🛍️ <strong>Шопинг:</strong> Голям базар, Египетски базар<br><br>

## 🔗 <strong>СЛЕДВАЩИ СТЪПКИ:</strong><br>

1. ✅ <strong>Потвърдете датите</strong> (±${conversationState.flexibleDays} дни)<br>
2. ✅ <strong>Изберете полети и хотел</strong><br>
3. ✅ <strong>Резервация с free cancellation</strong><br>
4. ✅ <strong>Получаване на детайли</strong><br><br>

📞 <strong>ЗА РЕЗЕРВАЦИЯ ИЛИ ПРОМЯНА:</strong><br>
<strong>Биляна: +359 885 07 89 80</strong><br>
<em>Можем да намерим най-добрите оферти за вашите предпочитания!</em>`;
}
